image: "python:3.7"

before_script:
- python --version
- pip install flake8 mypy pytest pytest-cov

.scope: &scope
    tags:
    - docker
    only:
    - master
    - merge_requests
    - web

stages:
- install
- lint
- unit_tests
- coverage


flake:
    <<: *scope
    stage: lint
    allow_failure: true
    script:
    - flake8 ./pcvsrt/

mypy:
    <<: *scope
    stage: lint
    allow_failure: true
    script:
    - python -m mypy ./pcvsrt/

main:
    <<: *scope
    coverage: '/TOTAL.+ ([0-9]{1,3}%)/'
    stage: unit_tests
    script:
    - pip install -e .
    - pytest ./tests/pcvsrt/cli

converter:
    <<: *scope
    coverage: '/TOTAL.+ ([0-9]{1,3}%)/'
    stage: unit_tests
    script:
    - pip install -e .
    - pytest ./tests/pcvsrt/converter

helpers:
    <<: *scope
    stage: unit_tests
    script:
    - pip install -e .
    - pytest ./tests/pcvsrt/helpers

full_nr:
    <<: *scope
    stage: coverage
    script:
    - pip install -e .
    - pytest ./tests/pcvsrt --cov=pcvsrt


pip:
    <<: *scope
    stage: install
    script:
    - pip3 install wheel
    - python3 setup.py bdist_wheel
    - pip3 install dist/*.whl
    - pcvs --version

from_sources:
    <<: *scope
    stage: install
    script:
    - mkdir dist_sources
    - python3 setup.py sdist --formats=gztar
    - tar xf dist/pcvsrt-*.tar.gz -C $PWD/dist_sources
    - python3 $PWD/dist_sources/*/setup.py install
    - pcvs --version

    
