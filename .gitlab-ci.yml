image: "python:3.7"

before_script:
- python --version
- pip install flake8 mypy pytest pytest-cov

.scope: &scope
    tags:
    - docker
    only:
    - master
    - merge_requests
    - web

stages:
- install
- cli_test
- lint

flake:
    <<: *scope
    stage: lint
    allow_failure: true
    script:
    - flake8 ./pcvsrt/

mypy:
    <<: *scope
    stage: lint
    allow_failure: true
    script:
    - python -m mypy ./pcvsrt/

cli_config:
    <<: *scope
    coverage: '/TOTAL.+ ([0-9]{1,3}%)/'
    stage: cli_test
    script:
    - pip install -e .
    - pytest ./tests/pcvsrt/cli --cov=pcvsrt --cov-report=xml -k _config

cli_profile:
    <<: *scope
    coverage: '/TOTAL.+ ([0-9]{1,3}%)/'
    stage: cli_test
    script:
    - pip3 install -e .
    - pytest ./tests/pcvsrt/cli --cov=pcvsrt --cov-report=xml -k _profile

cli_run:
    <<: *scope
    coverage: '/TOTAL.+ ([0-9]{1,3}%)/'
    stage: cli_test
    script:
    - pip install -e .
    - pytest ./tests/pcvsrt/cli --cov=pcvsrt --cov-report=xml -k _run

pip:
    <<: *scope
    stage: install
    script:
    - pip3 install wheel
    - python3 setup.py bdist_wheel
    - pip3 install dist/*.whl
    - pcvs --version

from_sources:
    <<: *scope
    stage: install
    script:
    - mkdir dist_sources
    - python3 setup.py sdist --formats=gztar
    - tar xf dist/pcvsrt-*.tar.gz -C $PWD/dist_sources
    - python3 $PWD/dist_sources/*/setup.py install
    - pcvs --version

    